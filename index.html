document.addEventListener("DOMContentLoaded", function () {
    const playerForm = document.getElementById("playerForm");
    const playerList = document.getElementById("playerList");
    const filterButton = document.getElementById("filterButton");

    async function uploadFile(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", meu_presetpo); // Substitua pelo seu Upload Preset

        try {
            let response = await fetch("https://api.cloudinary.com/v1_1/dpy5fezpf/upload", {
                method: "POST",
                body: formData
            });
            let data = await response.json();
            return data.secure_url; // Retorna a URL do arquivo no Cloudinary
        } catch (error) {
            console.error("Erro ao enviar arquivo:", error);
            alert("Erro ao enviar o documento!");
            return null;
        }
    }

    async function handleFormSubmit(event) {
        event.preventDefault();

        let documentInput = document.getElementById("document");
        let documentUrl = "";

        if (documentInput.files.length > 0) {
            let file = documentInput.files[0];
            documentUrl = await uploadFile(file);
            if (!documentUrl) return; // Se deu erro no upload, interrompe o processo
        }

        const newPlayer = {
            name: document.getElementById("name").value,
            position: document.getElementById("position").value,
            guardian: document.getElementById("guardian").value,
            contact: document.getElementById("contact").value,
            dob: document.getElementById("dob").value,
            document: documentUrl
        };

        let players = JSON.parse(localStorage.getItem("players")) || [];
        players.push(newPlayer);
        localStorage.setItem("players", JSON.stringify(players));

        alert("Jogador cadastrado com sucesso!");
        playerForm.reset();
        loadPlayers();
    }

    function loadPlayers(players = null) {
        if (!players) {
            players = JSON.parse(localStorage.getItem("players")) || [];
        }
        playerList.innerHTML = "";
        players.forEach((player, index) => {
            playerList.innerHTML += `
                <tr>
                    <td>${player.guardian}</td>
                    <td>${player.contact}</td>
                    <td>${player.name}</td>
                    <td>${player.dob}</td>
                    <td>${player.position}</td>
                    <td>
                        ${player.document ? `<a href="${player.document}" target="_blank" class="btn btn-secondary btn-sm">Ver Doc</a>` : "Nenhum documento"}
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePlayer(${index})">Excluir</button>
                    </td>
                </tr>`;
        });
    }

    function deletePlayer(index) {
        let players = JSON.parse(localStorage.getItem("players")) || [];
        players.splice(index, 1);
        localStorage.setItem("players", JSON.stringify(players));
        loadPlayers();
    }

    function filterPlayers() {
        let players = JSON.parse(localStorage.getItem("players")) || [];
        let searchQuery = document.getElementById("search").value.toLowerCase();
        let filterPosition = document.getElementById("filterPosition").value.toLowerCase();
        let filterYear = document.getElementById("filterYear").value;

        let filteredPlayers = players.filter(player => {
            let matchName = !searchQuery || player.name.toLowerCase().includes(searchQuery);
            let matchPosition = !filterPosition || player.position.toLowerCase().includes(filterPosition);
            let matchYear = !filterYear || player.dob.startsWith(filterYear);
            return matchName && matchPosition && matchYear;
        });

        loadPlayers(filteredPlayers);
    }

    filterButton.addEventListener("click", filterPlayers);
    playerForm.addEventListener("submit", handleFormSubmit);

    loadPlayers();
});


